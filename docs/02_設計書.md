# 🏗️ 設計書

## 📋 システム概要

### アーキテクチャ
```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                       │
├─────────────────────────────────────────────────────────────┤
│  UI Layer (React Components)                                │
│  ├── FileUpload.tsx    │  ChatUI.tsx    │  SearchExamples.tsx │
├─────────────────────────────────────────────────────────────┤
│  Business Logic Layer (TypeScript)                          │
│  ├── advanced-search-engine.ts │  gemini-api.ts │  data-manager.ts │
│  ├── excel-reader.ts   │  csv-reader.ts │  file-reader.ts     │
├─────────────────────────────────────────────────────────────┤
│  External APIs & Storage                                    │
│  ├── Gemini API        │  localStorage  │  xlsx/papaparse     │
└─────────────────────────────────────────────────────────────┘
```

### データフロー
```
1. ファイルアップロード
   Excel/CSV File → FileUpload → file-reader.ts → PersonInfo[]

2. データ保存
   PersonInfo[] → data-manager.ts → localStorage

3. 検索・チャット
   User Input → advanced-search-engine.ts → gemini-api.ts → Gemini API

4. 結果表示
   Response → ChatUI → User Interface
```

## 🔧 技術スタック

### フロントエンド
- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript 5.x
- **UI Library**: React 18
- **Styling**: Tailwind CSS
- **Build Tool**: Next.js built-in

### 外部ライブラリ
```json
{
  "xlsx": "^0.18.5",           // Excelファイル解析
  "papaparse": "^5.4.1",       // CSVファイル解析
  "@google/generative-ai": "^0.2.1",  // Gemini API
  "react": "^18.2.0",          // UIライブラリ
  "next": "^14.0.0",           // フレームワーク
  "typescript": "^5.0.0"       // 型システム
}
```

### 開発環境
- **Node.js**: 18.x以上
- **Package Manager**: npm
- **IDE**: VS Code推奨
- **OS**: Windows 10/11, macOS, Linux

## 📁 ファイル構造設計

### コアファイル

#### `src/lib/advanced-search-engine.ts`
```typescript
// 主要インターフェース
export interface Chunk {
  content: string;
  metadata: PersonInfo;
}

export interface AdvancedSearchResult {
  person: PersonInfo;
  relevance: number;
  matchType: 'exact' | 'partial' | 'semantic';
  explanation: string;
}

// 主要関数
export function initialize(persons: PersonInfo[]): void
export function search(query: string): AdvancedSearchResult[]
export function detectAggregationQuery(query: string): boolean
```

#### `src/lib/gemini-api.ts`
```typescript
// 主要インターフェース
export interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

// 主要関数
export async function searchPersonsWithGemini(query: string, persons: PersonInfo[]): Promise<string>
export async function chatWithPersons(message: string, persons: PersonInfo[]): Promise<string>
```

#### `src/lib/data-manager.ts`
```typescript
// 主要関数
export function addPersons(persons: PersonInfo[]): void
export function getPersons(): PersonInfo[]
export function addChatMessage(message: ChatMessage): void
export function getChatHistory(): ChatMessage[]
export function resetAllData(): void
```

### コンポーネント設計

#### `src/components/ChatUI.tsx`
- **役割**: チャットインターフェースの表示
- **機能**: メッセージ送信、履歴表示、クリア機能
- **Props**: `persons`, `onSendMessage`, `onClearHistory`

#### `src/components/FileUpload.tsx`
- **役割**: ファイルアップロード機能
- **機能**: ドラッグ&ドロップ、ファイル選択、アップロード処理
- **Props**: `onFileUpload`

#### `src/components/SearchExamples.tsx`
- **役割**: 検索例ボタンの表示
- **機能**: プリセット検索クエリの実行
- **Props**: `onExampleClick`

## 🔍 検索アルゴリズム設計

### 検索タイプの自動判定
```typescript
// 1. 完全一致検索
if (query.includes('さん') || query.includes('氏')) {
  // 名前での完全一致
}

// 2. キーワード検索
if (query.includes('得意') || query.includes('できる')) {
  // スキルでの検索
}

// 3. 部署検索
if (query.includes('部') || query.includes('部署')) {
  // 部署での検索
}

// 4. 集計検索
if (query.includes('何人') || query.includes('人数')) {
  // 集計処理
}
```

### 類似性計算
```typescript
// コサイン類似度の計算
function calculateCosineSimilarity(vec1: number[], vec2: number[]): number {
  const dotProduct = vec1.reduce((sum, val, i) => sum + val * vec2[i], 0);
  const magnitude1 = Math.sqrt(vec1.reduce((sum, val) => sum + val * val, 0));
  const magnitude2 = Math.sqrt(vec2.reduce((sum, val) => sum + val * val, 0));
  return dotProduct / (magnitude1 * magnitude2);
}
```

## 💾 データ設計

### PersonInfo型定義
```typescript
interface PersonInfo {
  name: string;           // 氏名
  department: string;     // 部署
  skills: string[];       // スキル（配列）
  qualifications: string[]; // 資格（配列）
  selfPR: string;        // 自己PR
  experience: string;     // 経験
  yearsOfExperience: number; // 経験年数
}
```

### データ永続化
```typescript
// localStorageキー
const STORAGE_KEYS = {
  PERSONS: 'rag_persons',
  CHAT_HISTORY: 'rag_chat_history'
};
```

## 🎨 UI/UX設計

### レイアウト構成
```
┌─────────────────────────────────────────────────────────────┐
│                    Header (File Upload)                     │
├─────────────────────────────────────────────────────────────┤
│  Left Panel          │           Right Panel               │
│  ├── Search Examples │           ├── Chat Interface        │
│  └── Error Log       │           └── Chat History          │
└─────────────────────────────────────────────────────────────┘
```

### レスポンシブデザイン
- **デスクトップ**: 2カラムレイアウト
- **タブレット**: 1カラムレイアウト（縦積み）
- **モバイル**: 1カラムレイアウト（縦積み）

### カラーパレット
```css
/* プライマリカラー */
--primary: #3B82F6;
--primary-dark: #2563EB;

/* セカンダリカラー */
--secondary: #6B7280;
--secondary-light: #9CA3AF;

/* アクセントカラー */
--accent: #10B981;
--accent-dark: #059669;

/* エラーカラー */
--error: #EF4444;
--warning: #F59E0B;
```

## 🔒 セキュリティ設計

### APIキー管理
```typescript
// 環境変数での管理
const apiKey = process.env.NEXT_PUBLIC_GEMINI_API_KEY;

// クライアントサイドでの使用
if (!apiKey) {
  throw new Error('Gemini APIキーが設定されていません');
}
```

### データ保護
- **個人情報**: ブラウザ内でのみ保存
- **API通信**: HTTPS経由での通信
- **エラーハンドリング**: 機密情報の漏洩防止

## 🚀 パフォーマンス設計

### 最適化戦略
1. **コード分割**: 動的インポートによる遅延読み込み
2. **キャッシュ**: localStorageによるデータキャッシュ
3. **非同期処理**: async/awaitによる非ブロッキング処理
4. **タイムアウト**: 長時間処理の制限

### エラーハンドリング
```typescript
// タイムアウト機能
const withTimeout = <T>(promise: Promise<T>, timeout: number): Promise<T> => {
  return Promise.race([
    promise,
    new Promise<never>((_, reject) =>
      setTimeout(() => reject(new Error('タイムアウト')), timeout)
    )
  ]);
};
```

## 📊 テスト設計

### 単体テスト
- **コンポーネントテスト**: React Testing Library
- **ユーティリティテスト**: Jest
- **型チェック**: TypeScript

### 統合テスト
- **API連携テスト**: Gemini APIとの通信
- **ファイル処理テスト**: Excel/CSV読み込み
- **UI操作テスト**: ユーザーインタラクション

## 🔮 将来の拡張設計

### データベース連携
```typescript
// 将来的なDB設計
interface DatabaseConfig {
  type: 'postgresql' | 'mongodb' | 'sqlite';
  connectionString: string;
  tableName: string;
}
```

### 認証システム
```typescript
// 将来的な認証設計
interface AuthConfig {
  provider: 'google' | 'github' | 'email';
  permissions: string[];
}
```

---

**作成日**: 2024年12月  
**最終更新**: 2024年12月  
**バージョン**: 1.0.0 
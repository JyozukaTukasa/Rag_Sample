# RAGチャットボット開発の流れ - 実装記録

## 📋 プロジェクト概要

**プロジェクト名**: ドキュメント検索型チャットボット（人物スキル情報検索システム）  
**技術スタック**: Next.js, TypeScript, Gemini API, Excel/CSV解析  
**開発期間**: 2025年7月 - 2025年8月  

## 🎯 開発目標

会社内の人物スキル情報をExcel/CSVファイルから読み込み、自然言語で検索・質問できるチャットボットシステムの構築

## 📚 開発の流れ

### Phase 1: 要件定義・設計

#### 1.1 要件定義
- **機能要件**:
  - Excel/CSVファイルのアップロード・解析
  - 人物情報の検索機能
  - 自然言語での質問応答
  - チャット履歴の保存

- **非機能要件**:
  - レスポンシブなWeb UI
  - 5MB以下のファイルサイズ制限
  - 30秒以内のファイル解析
  - 直感的な操作性

#### 1.2 技術選定
- **フロントエンド**: Next.js + TypeScript + React
- **UI/UX**: Tailwind CSS + CSS Modules
- **AI/検索**: Gemini API
- **データ管理**: localStorage（ローカル完結）
- **ファイル解析**: xlsx（Excel読み込み）, papaparse（CSV読み込み）

#### 1.3 システム設計
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ファイル       │    │   解析・変換     │    │   検索・チャット  │
│   アップロード   │───▶│   エンジン      │───▶│   システム      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Excel/CSV     │    │   PersonInfo    │    │   Gemini API    │
│   ファイル       │    │   構造体        │    │   自然言語処理   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Phase 2: 環境構築・基盤開発

#### 2.1 プロジェクト初期化
```bash
# Next.jsプロジェクト作成
npx create-next-app@latest rag_portfolio --typescript --tailwind --eslint

# 必要なライブラリのインストール
npm install xlsx @google/generative-ai papaparse
```

#### 2.2 プロジェクト構造
```
rag_portfolio/
├── app/
│   ├── page.tsx              # メインページ
│   ├── globals.css           # グローバルスタイル
│   └── layout.tsx            # レイアウト
├── src/
│   ├── components/           # UIコンポーネント
│   │   ├── FileUpload.tsx
│   │   ├── ChatUI.tsx
│   │   └── SearchExamples.tsx
│   ├── lib/                  # ビジネスロジック
│   │   ├── excel-reader.ts   # Excel解析
│   │   ├── csv-reader.ts     # CSV解析
│   │   ├── gemini-api.ts     # AI API連携
│   │   ├── data-manager.ts   # データ管理
│   │   ├── file-reader.ts    # 統合ファイル読み込み
│   │   └── advanced-search-engine.ts # 高度な検索エンジン
│   └── types/                # 型定義
│       └── index.ts          # 共通型定義
├── test/                     # テストデータ
│   ├── sample_personnel.csv
│   └── sample_personnel_detailed.csv
└── scripts/                  # ユーティリティ
    ├── create_sample_excel.py
    └── create_sample_pdf.py
```

### Phase 3: コア機能実装

#### 3.1 ファイル解析機能
**ファイル**: `src/lib/excel-reader.ts`, `src/lib/csv-reader.ts`

```typescript
export interface PersonInfo {
  name: string;           // 氏名
  department: string;     // 部署
  skills: string[];       // スキル配列
  qualifications: string[]; // 資格配列
  selfPR: string;         // 自己PR
  experience: string;     // 開発経験
  yearsOfExperience: number; // 経験年数
}
```

**主要機能**:
- Excelファイルの読み込み（xlsxライブラリ使用）
- CSVファイルの読み込み（papaparseライブラリ使用）
- 全行データの解析
- スキル・資格の配列変換
- 経験年数の数値変換
- エラーハンドリング・タイムアウト処理

#### 3.2 高度な検索エンジン
**ファイル**: `src/lib/advanced-search-engine.ts`

**主要機能**:
- チャンク化による情報分割
- コサイン類似度による検索
- 質問タイプ分析（exact_search, fuzzy_search, analytical, general_question）
- 会話的な質問への対応
- 集計・統計機能
- 完全一致・部分一致の優先処理

#### 3.3 AI検索機能
**ファイル**: `src/lib/gemini-api.ts`

**主要機能**:
- Gemini APIとの連携
- 質問タイプに応じたプロンプト生成
- 知的な回答生成
- 人物情報のサマリー作成
- 組織分析・統計情報の提供

#### 3.4 データ管理機能
**ファイル**: `src/lib/data-manager.ts`

**主要機能**:
- localStorageを使用したデータ永続化
- 人物情報の保存・取得
- チャット履歴の管理
- データリセット機能

### Phase 4: UI/UX実装

#### 4.1 レイアウト設計
**2列グリッドレイアウト**:
- **左側**: ファイルアップロード + 検索例
- **右側**: チャット画面（スクロール可能）

#### 4.2 コンポーネント設計

**FileUpload.tsx**:
- ドラッグ&ドロップ対応
- ファイル形式・サイズチェック
- ローディング表示

**ChatUI.tsx**:
- メッセージ表示
- 入力フォーム
- 自動スクロール
- 履歴削除機能

**SearchExamples.tsx**:
- 事前定義された検索例
- ワンクリック検索

### Phase 5: 統合・テスト

#### 5.1 統合ポイント
**メインページ** (`app/page.tsx`):
- 全コンポーネントの統合
- 状態管理
- イベントハンドリング
- エラー処理

#### 5.2 テストデータ
**基本版** (`sample_personnel.csv`):
- 3名の人物データ
- 基本的なスキル・資格情報

**詳細版** (`sample_personnel_detailed.csv`):
- 5名の人物データ
- 複数のスキル・資格
- 詳細な経験情報

### Phase 6: 高度な検索機能実装（2025年8月1日）

#### 6.1 新しい要件
- **CSVファイル対応**: `sample_personnel.csv`のデータ読み込み
- **高度な検索機能**: 
  - 集計機能（「開発部に所属している人は何人ですか？」）
  - 類似性検索（「Web系のエンジニアはいますか？」）
  - 曖昧な質問への対応
- **チャンク化**: 1000文字単位、200文字オーバーラップ
- **コサイン類似度**: 高精度な検索結果

#### 6.2 技術的課題
- **エラー修正**: `date.toLocaleTimeString is not a function`
- **データ型整合性**: localStorageのDate型変換
- **検索精度向上**: Gemini APIを使ったクエリ解釈
- **パフォーマンス最適化**: 必要に応じてライブラリ追加

#### 6.3 実装方針
1. **CSV読み込み機能の強化**
2. **高度な検索エンジンの構築**
3. **チャンク化・ベクトル化システム**
4. **集計・統計機能**
5. **エラーハンドリングの強化**

### Phase 7: コード整理・最適化（2025年8月1日）

#### 7.1 UI/UXの改善
- **エラーログ表示の削除**: アプリケーションとして不要な表示要素を削除
- **Gemini API状態表示の削除**: 開発用の表示を削除
- **2列レイアウトへの変更**: よりシンプルで使いやすいUI
- **不要なコンポーネントの削除**: ErrorDisplay, ApiStatusコンポーネントを削除

#### 7.2 コード構造の整理
- **型定義の統一**: `src/types/index.ts`で共通型定義を管理
- **不要なファイルの削除**: search-engine.ts, pdf-reader.tsを削除
- **インポートの整理**: 各ファイルで型定義のインポートを統一
- **PDF対応の削除**: 現在使用していないPDF機能を削除

#### 7.3 エラーハンドリングの簡素化
- **エラー表示の削除**: UIでのエラー表示を削除し、コンソールログのみに変更
- **警告メッセージの簡素化**: ユーザーフレンドリーな警告に変更
- **不要な関数の削除**: エラー管理関連の関数を削除

### Phase 8: UI最適化・コンパクト化（2025年8月1日）

#### 8.1 ファイルアップロードUIの最適化
- **CSSモジュールの削除**: `FileUpload.module.css`を削除し、Tailwind CSSに統一
- **コンポーネントサイズの縮小**: パディング、マージン、フォントサイズを大幅に縮小
- **ドラッグ&ドロップエリアの簡素化**: より小さく、直感的なデザインに変更
- **不要な要素の削除**: ヘルプテキスト、ファイル選択ボタンを削除

#### 8.2 レイアウトの最適化
- **パディングの縮小**: 左側のパディングを`p-4`から`p-2`に変更
- **コンポーネント間隔の調整**: マージンを`mb-4`から`mb-3`に変更
- **検索例ボタンの縮小**: ボタンのパディングとフォントサイズを縮小

#### 8.3 デザインの統一
- **シャドウの統一**: `shadow-md`から`shadow-sm`に変更
- **ボーダーの追加**: より明確な境界線を追加
- **色の調整**: より控えめで洗練された色合いに変更

## 🔧 技術的課題と解決策

### 課題1: PowerShell構文エラー
**問題**: `&&`演算子がPowerShellで使用できない
**解決策**: コマンドを分離して実行

### 課題2: ファイル解析のフリーズ
**問題**: 大きなファイルで処理が停止
**解決策**: Promise.raceによるタイムアウト処理（30秒）

### 課題3: UIレイアウトの調整
**問題**: スクロール・サイズ調整が困難
**解決策**: CSS Grid + Flexboxの組み合わせ

### 課題4: データ型の整合性
**問題**: Excelデータの型変換エラー
**解決策**: 堅牢なパース関数の実装

### 課題5: 時刻表示エラー（2025年8月1日）
**問題**: `date.toLocaleTimeString is not a function`
**解決策**: 
- ChatUI.tsxで文字列とDateオブジェクトの両方に対応
- data-manager.tsでlocalStorage読み込み時にDate型変換

### 課題6: 検索精度の向上（2025年8月1日）
**問題**: 曖昧な質問への対応が不十分
**解決策**:
- Gemini APIを使ったクエリ解釈機能
- 二段階検索システム（解釈クエリ→元クエリ）
- カテゴリ別関連性計算

### 課題7: チャット入力と検索例の動作不一致（2025年8月1日）
**問題**: 同じクエリでもチャット入力と検索例ボタンで異なる結果
**解決策**:
- `handleSendMessage`で`searchPersonsWithGemini`を使用するように統一
- 両方の処理で同じ高度な検索エンジンを使用

### 課題8: コードの整理と最適化（2025年8月1日）
**問題**: 不要な表示要素やファイルが残っている
**解決策**:
- エラーログ表示とAPI状態表示を削除
- 不要なコンポーネントファイルを削除
- 型定義を統一して管理
- PDF関連の機能を削除

## 📊 実装成果

### 機能完成度
- ✅ Excelファイル読み込み・解析
- ✅ CSVファイル読み込み・解析
- ✅ 人物情報の構造化
- ✅ 高度な検索・チャット機能
- ✅ エラーハンドリング
- ✅ レスポンシブUI
- ✅ データ永続化
- ✅ Gemini API連携
- ✅ クエリ解釈機能
- ✅ 集計・統計機能
- ✅ 会話的な質問対応
- ✅ コード整理・最適化

### パフォーマンス
- ファイル解析: 30秒以内
- 検索応答: 10秒以内
- UI応答: 即座

### コード品質
- TypeScript型安全性
- エラーハンドリング
- ログ出力
- コメント記述
- 統一された型定義
- 整理されたファイル構造

## 🚀 次のステップ

### 短期目標（2025年8月1日）
1. **機能テスト**
   - 各種検索パターンのテスト
   - エラーハンドリングの確認
   - パフォーマンスの検証

2. **ドキュメント整備**
   - ユーザーマニュアルの作成
   - API仕様書の作成
   - デプロイ手順書の作成

### 中期目標
1. **バックエンド連携**
   - データベース保存
   - ユーザー認証
   - API化

2. **機能拡張**
   - 画像認識
   - 音声入力
   - 多言語対応

## 📝 学習ポイント

### 技術的学習
- Next.js 13+ App Router
- TypeScript型システム
- Gemini API活用
- Excel/CSV解析技術
- レスポンシブデザイン
- ベクトル検索技術
- チャンク化・オーバーラップ技術
- RAG（Retrieval-Augmented Generation）システム

### 開発プロセス学習
- 要件定義から実装まで
- 段階的な機能実装
- エラーハンドリング
- テスト駆動開発
- ドキュメント作成
- パフォーマンス最適化
- コード整理・リファクタリング

## 🎉 プロジェクト成果

このプロジェクトにより、以下のスキルを習得：

1. **フルスタック開発**: フロントエンドからAI連携まで
2. **モダン技術**: Next.js, TypeScript, Tailwind CSS
3. **AI活用**: Gemini APIによる自然言語処理
4. **データ処理**: Excel/CSV解析・構造化
5. **UX設計**: 直感的なユーザーインターフェース
6. **検索技術**: ベクトル検索・チャンク化・類似度計算
7. **RAGシステム**: 検索と生成を組み合わせたAIシステム

**ポートフォリオとして活用可能な実用的なWebアプリケーションが完成！**

---

*最終更新: 2025年8月1日*
